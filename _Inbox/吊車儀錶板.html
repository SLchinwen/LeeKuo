<!doctype html>
<html lang="zh-Hant">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>整廠停駐點效益儀表板（白底黑字 Demo）</title>
  <style>
    :root{
      --bg:#ffffff;
      --card:#ffffff;
      --text:#222222;
      --muted:#666666;
      --line:#dddddd;

      /* status */
      --ok:#1f7a3a;       /* 可吊卸 */
      --plan:#b8860b;     /* 排吊卸 */
      --shadow: 0 10px 26px rgba(0,0,0,.08);
    }

    *{box-sizing:border-box}
    body{
      margin:0;
      font-family: ui-sans-serif, system-ui, -apple-system, "Noto Sans TC", "PingFang TC", "Microsoft JhengHei", Arial, sans-serif;
      background: var(--bg);
      color: var(--text);
    }

    header{
      padding:14px 16px;
      border-bottom:1px solid var(--line);
      position: sticky;
      top: 0;
      background: #fff;
      z-index: 20;
    }
    header h1{ font-size:18px; margin:0 0 6px; font-weight:900; }
    header .sub{ color:var(--muted); font-size:13px; line-height:1.55; }

    .wrap{ max-width:1320px; margin:0 auto; padding:14px 16px 34px; }

    .card{
      background: var(--card);
      border:1px solid var(--line);
      border-radius:12px;
      padding:14px;
      box-shadow: var(--shadow);
      margin-bottom: 12px;
    }

    .row{ display:flex; gap:10px; flex-wrap:wrap; align-items:center; justify-content:space-between; }
    .muted{ color:var(--muted); font-size:13px; line-height:1.55; }
    h2{ margin:0 0 8px; font-size:16px; }
    .divider{ height:1px; background: var(--line); margin:10px 0; }

    .chips{ display:flex; gap:8px; flex-wrap:wrap; align-items:center; }
    .pill{
      font-size:12px; padding:4px 8px; border-radius:999px;
      border:1px solid var(--line);
      color: var(--muted);
      background: #f7f7f7;
      white-space: nowrap;
    }

    button{
      border:1px solid var(--line);
      background:#f7f7f7;
      color:var(--text);
      padding:9px 12px;
      border-radius:10px;
      cursor:pointer;
      font-weight:900;
      white-space: nowrap;
    }
    button.primary{
      background:#e9f2ff;
      border-color:#b6d3ff;
    }
    button.warn{
      background:#fff6df;
      border-color:#f0d38a;
    }
    button.danger{
      background:#ffe9e9;
      border-color:#ffc1c1;
    }
    button:active{ transform: translateY(1px); }
    button:disabled{ opacity:.45; cursor:not-allowed; transform:none; }

    .kpi{
      display:grid;
      grid-template-columns: repeat(2, 1fr);
      gap:10px;
      margin-top:10px;
    }
    @media (min-width: 760px){ .kpi{ grid-template-columns: repeat(4, 1fr);} }
    .kpi .box{
      border:1px solid var(--line);
      border-radius:12px;
      padding:10px;
      background: #fbfbfb;
    }
    .kpi .box .t{ color:var(--muted); font-size:12px; font-weight:800; }
    .kpi .box .v{ font-size:18px; font-weight:950; margin-top:6px; }

    .tableWrap{
      overflow:auto;
      border-radius:12px;
      border:1px solid var(--line);
      background: #fff;
    }
    table{
      width:100%;
      border-collapse: collapse;
      min-width: 980px;
    }
    th, td{
      padding:10px 10px;
      border-bottom:1px solid var(--line);
      font-size:13px;
      vertical-align:top;
      background:#fff;
    }
    th{
      text-align:left;
      color: var(--muted);
      font-weight:900;
      background: #f7f7f7;
      position: sticky;
      top: 0;
      z-index: 5;
      white-space: nowrap;
    }
    tr:hover td{ background: #fafafa; }
    .right{ text-align:right; white-space: nowrap; }

    /* number pill */
    .num{
      display:inline-flex;
      align-items:center;
      justify-content:center;
      min-width: 44px;
      padding:6px 10px;
      border-radius:10px;
      font-weight:950;
      border:1px solid var(--line);
      cursor:pointer;
      user-select:none;
      background:#fff;
    }
    .num.ok{
      border-color: rgba(31,122,58,.35);
      background: rgba(31,122,58,.08);
      color: var(--ok);
    }
    .num.plan{
      border-color: rgba(184,134,11,.35);
      background: rgba(184,134,11,.08);
      color: var(--plan);
    }
    .num:hover{ filter: brightness(0.98); }

    .badge{
      display:inline-flex; align-items:center; gap:6px;
      padding:6px 10px;
      border-radius:999px;
      border:1px solid var(--line);
      background: #f7f7f7;
      color: var(--muted);
      font-size:12px;
      white-space: nowrap;
      font-weight:900;
    }
    .tiny{ font-size:12px; color:var(--muted); line-height:1.55; }

    /* modal */
    .overlay{
      position: fixed; inset:0;
      background: rgba(0,0,0,.35);
      display:none;
      align-items:center;
      justify-content:center;
      padding: 16px;
      z-index: 999;
    }
    .overlay.show{ display:flex; }
    .modal{
      width: min(980px, 96vw);
      max-height: 92vh;
      overflow:auto;
      border-radius: 14px;
      border:1px solid var(--line);
      background: #fff;
      box-shadow: 0 22px 60px rgba(0,0,0,.18);
    }
    .modal header{
      position: sticky;
      top: 0;
      background: #fff;
      border-bottom: 1px solid var(--line);
    }
    .modal .content{ padding: 14px; }
    .x{
      border:1px solid var(--line);
      background: #f7f7f7;
      border-radius: 10px;
      padding: 8px 10px;
      cursor:pointer;
      color: var(--text);
      font-weight: 950;
    }

    /* assign form */
    label{ display:block; font-size:12.5px; color:var(--muted); margin:10px 0 6px; font-weight:900; }
    input, select, textarea{
      width:100%;
      padding:10px 10px;
      border-radius:10px;
      border:1px solid var(--line);
      background:#fff;
      color:var(--text);
      outline:none;
    }
    textarea{ min-height:70px; resize: vertical; }
    input:focus, select:focus, textarea:focus{
      border-color: #7aa7ff;
      box-shadow: 0 0 0 3px rgba(122,167,255,.18);
    }
    .fields{ display:grid; grid-template-columns: 1fr; gap:10px; }
    @media (min-width: 760px){ .fields{ grid-template-columns: 1fr 1fr; } }

    /* print */
    @media print{
      header, .wrap, .overlay, .toast{ display:none !important; }
      #printOnly{ display:block !important; }
      body{ background:white; }
    }
    #printOnly{ display:none; padding: 18px; }
    .printPage{
      background: white;
      color: #111;
      border-radius: 0;
      padding: 0;
      border: none;
    }
    .printPage h2{ margin:0 0 6px; }
    .printMeta{
      display:grid;
      grid-template-columns: 1fr 1fr;
      gap:10px;
      font-size: 12px;
      margin: 8px 0 10px;
    }
    .printTable{
      width: 100%;
      border-collapse: collapse;
      margin-top: 10px;
      font-size: 12px;
    }
    .printTable th, .printTable td{
      border: 1px solid #ddd;
      padding: 8px;
      vertical-align: top;
    }
    .printTable th{ background: #f6f6f6; text-align:left; }

    .toast{
      position: fixed;
      right: 16px;
      bottom: 16px;
      background: rgba(0,0,0,.78);
      border:1px solid rgba(255,255,255,.15);
      color: #fff;
      padding: 10px 12px;
      border-radius: 12px;
      font-size: 13px;
      opacity: 0;
      transform: translateY(8px);
      transition: .18s ease;
      z-index: 9999;
      max-width: 72vw;
    }
    .toast.show{ opacity:1; transform: translateY(0); }
  </style>
</head>

<body>
<header>
  <div class="row" style="max-width:1320px;margin:0 auto;">
    <div>
      <h1>整廠停駐點效益儀表板（吊車分派 Demo）</h1>
      <div class="sub">
        只保留兩區：<b>停駐區</b>（快速查詢）＋ <b>已派工區</b>（列印/刪除）。<br/>
        數量分兩類：<b>60噸以下</b> 與 <b>60噸以上</b>。全畫面無英文；狀態用「可吊卸 / 排吊卸」。
      </div>
    </div>
    <div class="chips">
      <span class="pill">可吊卸：現在就能吊</span>
      <span class="pill">排吊卸：等前面工序做完</span>
      <span class="pill">點數字看設備＋目前工序</span>
    </div>
  </div>
</header>

<div class="wrap">

  <!-- 1) 停駐區 -->
  <div class="card">
    <div class="row">
      <div>
        <h2>1) 停駐區（效益查詢）</h2>
        <div class="muted">點數字可查設備清單（設備編號＋目前工序＋工序數＋需求噸數＋狀態說明）。</div>
      </div>
      <div class="chips">
        <span class="pill" id="dayLabel">日期：—</span>
        <span class="pill">窗口 08:00–17:00（示意）</span>
        <button class="primary" id="btnRefresh">重新整理（示意）</button>
      </div>
    </div>

    <div class="kpi">
      <div class="box">
        <div class="t">停駐點數</div>
        <div class="v" id="kpiStands">—</div>
      </div>
      <div class="box">
        <div class="t">全廠可吊卸（≤60 / >60）</div>
        <div class="v" id="kpiOk">—</div>
      </div>
      <div class="box">
        <div class="t">全廠排吊卸（≤60 / >60）</div>
        <div class="v" id="kpiPlan">—</div>
      </div>
      <div class="box">
        <div class="t">已派工（預定派車）</div>
        <div class="v" id="kpiAssign">—</div>
      </div>
    </div>

    <div class="divider"></div>

    <div class="tableWrap">
      <table>
        <thead>
          <tr>
            <th style="width:64px;">順序</th>
            <th>停駐點</th>
            <th class="right">≤60 可吊卸</th>
            <th class="right">&gt;60 可吊卸</th>
            <th class="right">≤60 排吊卸</th>
            <th class="right">&gt;60 排吊卸</th>
            <th class="right">操作</th>
          </tr>
        </thead>
        <tbody id="tbDashboard"></tbody>
      </table>
    </div>

    <div class="tiny" style="margin-top:10px;">
      提醒：Demo 假資料示意。正式版由「每日報工系統」＋「停駐點主檔」供數。
    </div>
  </div>

  <!-- 2) 已派工區 -->
  <div class="card">
    <div class="row">
      <div>
        <h2>2) 已派工區（列印 / 刪除）</h2>
        <div class="muted">以「停駐點 + 噸數 + 入場日期」建檔；本區只做管理與提供進場表。</div>
      </div>
      <div class="chips">
        <span class="pill">每筆可列印進場表</span>
      </div>
    </div>

    <div class="divider"></div>

    <div class="tableWrap">
      <table style="min-width: 980px;">
        <thead>
          <tr>
            <th>編號</th>
            <th>入場日期</th>
            <th>停駐點</th>
            <th class="right">噸數</th>
            <th>廠商</th>
            <th>建立當下快照（可吊卸/排吊卸）</th>
            <th>備註</th>
            <th class="right">操作</th>
          </tr>
        </thead>
        <tbody id="tbAssignments"></tbody>
      </table>
    </div>
  </div>

</div>

<!-- 設備清單 Modal -->
<div class="overlay" id="ovQuick">
  <div class="modal">
    <header>
      <div class="row" style="max-width:980px;margin:0 auto;">
        <div>
          <h1 id="qTitle" style="font-size:16px;margin:0;">設備清單</h1>
          <div class="sub" id="qSub">—</div>
        </div>
        <div class="chips">
          <button class="x" id="btnQClose">關閉</button>
        </div>
      </div>
    </header>
    <div class="content">
      <div class="tableWrap">
        <table style="min-width: 860px;">
          <thead>
            <tr>
              <th>設備編號</th>
              <th>目前工序</th>
              <th class="right">工序數</th>
              <th class="right">需求噸數</th>
              <th>狀態說明</th>
            </tr>
          </thead>
          <tbody id="tbQuick"></tbody>
        </table>
      </div>

      <div class="divider"></div>

      <div class="row">
        <div class="muted">要派車：回到儀表板該停駐點按【預定派車】建立資料。</div>
        <button class="primary" id="btnGoAssign">用此停駐點預定派車</button>
      </div>
    </div>
  </div>
</div>

<!-- 預定派車 Modal -->
<div class="overlay" id="ovAssign">
  <div class="modal" style="width:min(720px,96vw);">
    <header>
      <div class="row" style="max-width:720px;margin:0 auto;">
        <div>
          <h1 style="font-size:16px;margin:0;">預定派車</h1>
          <div class="sub" id="aSub">—</div>
        </div>
        <div class="chips">
          <button class="x" id="btnAClose">關閉</button>
        </div>
      </div>
    </header>
    <div class="content">
      <label>停駐點（已選）</label>
      <input id="aStand" type="text" disabled />

      <div class="fields">
        <div>
          <label>入場日期</label>
          <input id="aDate" type="date" />
        </div>
        <div>
          <label>吊車噸數</label>
          <select id="aTon"></select>
        </div>
      </div>

      <label>吊車廠商</label>
      <select id="aVendor"></select>

      <label>備註（選填）</label>
      <textarea id="aNote" placeholder="例如：趕工、需配合工檢、限制時間…"></textarea>

      <div class="divider"></div>

      <div class="chips">
        <span class="pill" id="aHintOk">可吊卸：—</span>
        <span class="pill" id="aHintPlan">排吊卸：—</span>
      </div>

      <div class="divider"></div>
      <div class="row">
        <button class="primary" id="btnACreate">建立已派工</button>
        <button id="btnACancel">取消</button>
      </div>
    </div>
  </div>
</div>

<div class="toast" id="toast"></div>
<div id="printOnly"></div>

<script>
  /************************************************************
   * Demo Data
   * 停駐點：只顯示 A/B/C（不出現 P-xx）
   * 狀態：可吊卸 / 排吊卸
   * Expected 不需要原因/時間 → 用目前工序 + 工序數讓主任判斷
   ************************************************************/
  const STANDS = [
    { stand:"A" },
    { stand:"B" },
    { stand:"C" }
  ];

  // 設備清單：每筆都有 目前工序 + 工序數 + 需求噸數 + 狀態說明
  // status: "ok"=可吊卸, "plan"=排吊卸
 const STAND_TASKS = {
  "A": {
    ok: [
      {eq:"E-5411A", step:"端蓋吊卸", stepCount:2, ton:120, statusText:"可吊卸"},
      {eq:"E-5408A", step:"本體吊裝", stepCount:1, ton:160, statusText:"可吊卸"},
      {eq:"E-5407A", step:"端蓋吊卸", stepCount:2, ton:60,  statusText:"可吊卸"}
    ],
    plan: [
      {
        eq:"E-5411B",
        step:"端蓋清洗",
        stepCount:2,
        ton:160,
        statusText:"排吊卸",
        preLiftTodoSteps:[
          "端蓋清洗完成",
          "螺栓/螺帽確認已拆除",
          "清場/隔離完成（吊車作業範圍）"
        ],
        note:"建議先排清洗＋清場，完成即可轉可吊掛"
      },
      {
        eq:"E-5408B",
        step:"螺栓拆除",
        stepCount:3,
        ton:120,
        statusText:"排吊卸",
        preLiftTodoSteps:[
          "螺栓拆除完成",
          "吊點/吊耳確認",
          "動火/作業許可確認（若需要）"
        ],
        note:"拆完螺栓後即可進吊掛準備"
      }
    ]
  },

  "B": {
    ok: [
      {eq:"E-5501A", step:"端蓋吊卸", stepCount:2, ton:120, statusText:"可吊卸"},
      {eq:"E-5501B", step:"端蓋吊卸", stepCount:2, ton:120, statusText:"可吊卸"},
      {eq:"E-5407B", step:"端蓋吊卸", stepCount:2, ton:60,  statusText:"可吊卸"},
      {eq:"E-5410",  step:"端蓋吊卸", stepCount:2, ton:120, statusText:"可吊卸"}
    ],
    plan: [
      {
        eq:"E-5502A",
        step:"本體拆卸",
        stepCount:4,
        ton:160,
        statusText:"排吊卸",
        preLiftTodoSteps:[
          "本體拆卸完成（關鍵緊固件/支撐移除）",
          "吊點確認（中心/平衡）",
          "清場/隔離完成（吊車迴轉半徑）",
          "運輸路線/堆置區確認"
        ],
        note:"大件，建議先趕拆卸與吊點確認"
      }
    ]
  },

  "C": {
    ok: [
      {eq:"E-5403A", step:"端蓋吊卸", stepCount:2, ton:120, statusText:"可吊卸"},
      {eq:"E-5403B", step:"端蓋吊卸", stepCount:2, ton:120, statusText:"可吊卸"}
    ],
    plan: [
      {
        eq:"E-5405A",
        step:"吊裝準備",
        stepCount:3,
        ton:160,
        statusText:"排吊卸",
        preLiftTodoSteps:[
          "吊點/吊耳確認",
          "工器具/索具到位",
          "清場/隔離完成（含警戒線）"
        ],
        note:"準備完成即可轉可吊掛"
      },
      {
        eq:"E-5406A",
        step:"清場/隔離",
        stepCount:3,
        ton:120,
        statusText:"排吊卸",
        preLiftTodoSteps:[
          "清場完成（障礙移除）",
          "隔離完成（警戒線/告示）",
          "吊車站位與支撐墊板確認"
        ],
        note:"這台卡在場地條件，先處理清場隔離"
      }
    ]
  }
};


  const TON_CHOICES = [60, 120, 160];
  const VENDORS = [
    { id:"OO", name:"OO吊車公司" },
    { id:"XX", name:"XX吊車公司" },
    { id:"YY", name:"YY吊車公司" }
  ];

  let assignments = [];
  let seq = 1;

  const $ = (s)=>document.querySelector(s);
  const $$ = (s)=>Array.from(document.querySelectorAll(s));

  function escapeHtml(s){
    return (s??"").toString()
      .replaceAll("&","&amp;")
      .replaceAll("<","&lt;")
      .replaceAll(">","&gt;")
      .replaceAll('"',"&quot;")
      .replaceAll("'","&#039;");
  }

  function toast(msg){
    const el = $("#toast");
    el.textContent = msg;
    el.classList.add("show");
    setTimeout(()=>el.classList.remove("show"), 1400);
  }

  function tomorrowISO(){
    const d = new Date();
    d.setDate(d.getDate()+1);
    const yyyy = d.getFullYear();
    const mm = String(d.getMonth()+1).padStart(2,"0");
    const dd = String(d.getDate()).padStart(2,"0");
    return `${yyyy}-${mm}-${dd}`;
  }

  function splitCounts(list){
    let le60 = 0, gt60 = 0;
    for(const x of list){
      const t = Number(x.ton);
      if(Number.isFinite(t) && t <= 60) le60++;
      else gt60++;
    }
    return { le60, gt60 };
  }

  function getStandAgg(stand){
    const obj = STAND_TASKS[stand] || {ok:[], plan:[]};
    const ok = splitCounts(obj.ok);
    const plan = splitCounts(obj.plan);
    return {
      ok, plan,
      totalOk: obj.ok.length,
      totalPlan: obj.plan.length
    };
  }

  /************************************************************
   * Render Dashboard (順序 1,2,3... 依「可吊卸總數」由大到小)
   ************************************************************/
  function renderDashboard(){
    const sorted = [...STANDS].sort((a,b)=>{
      const A = getStandAgg(a.stand).totalOk;
      const B = getStandAgg(b.stand).totalOk;
      return B - A || a.stand.localeCompare(b.stand);
    });

    const rows = sorted.map((s, idx)=>{
      const agg = getStandAgg(s.stand);

      const okPill = (n, stand, band) => `
        <span class="num ok"
          data-stand="${stand}" data-kind="ok" data-band="${band}"
          title="點擊查看設備清單"
        >${n}</span>
      `;
      const planPill = (n, stand, band) => `
        <span class="num plan"
          data-stand="${stand}" data-kind="plan" data-band="${band}"
          title="點擊查看設備清單"
        >${n}</span>
      `;

      return `
        <tr>
          <td><b>${idx+1}</b></td>
          <td><b>${s.stand}</b></td>
          <td class="right">${okPill(agg.ok.le60, s.stand, "le60")}</td>
          <td class="right">${okPill(agg.ok.gt60, s.stand, "gt60")}</td>
          <td class="right">${planPill(agg.plan.le60, s.stand, "le60")}</td>
          <td class="right">${planPill(agg.plan.gt60, s.stand, "gt60")}</td>
          <td class="right"><button class="primary" data-assign="${s.stand}">預定派車</button></td>
        </tr>
      `;
    }).join("");

    $("#tbDashboard").innerHTML = rows;

    // KPI
    const totals = STANDS.reduce((acc,s)=>{
      const a = getStandAgg(s.stand);
      acc.okLe60 += a.ok.le60; acc.okGt60 += a.ok.gt60;
      acc.planLe60 += a.plan.le60; acc.planGt60 += a.plan.gt60;
      return acc;
    }, {okLe60:0, okGt60:0, planLe60:0, planGt60:0});

    $("#kpiStands").textContent = STANDS.length;
    $("#kpiOk").textContent = `${totals.okLe60} / ${totals.okGt60}`;
    $("#kpiPlan").textContent = `${totals.planLe60} / ${totals.planGt60}`;
    $("#kpiAssign").textContent = assignments.length;

    // bind number clicks
    $$("#tbDashboard .num").forEach(el=>{
      el.addEventListener("click", ()=>{
        openQuick(el.dataset.stand, el.dataset.kind, el.dataset.band);
      });
    });

    // bind assign
    $$("#tbDashboard button[data-assign]").forEach(btn=>{
      btn.addEventListener("click", ()=>{
        openAssignFromDashboard(btn.getAttribute("data-assign"));
      });
    });
  }

  /************************************************************
   * Quick View (設備清單) — 顯示：
   * 設備編號 / 目前工序 / 工序數 / 需求噸數 / 狀態說明
   * 不需要原因/時間
   ************************************************************/
  let quickStand = null;
  let quickKind = null;
  let quickBand = null;

  function openQuick(stand, kind, band){
    quickStand = stand;
    quickKind = kind;
    quickBand = band;

    const agg = getStandAgg(stand);
    const bandLabel = band === "le60" ? "60噸以下" : "60噸以上";
    const kindLabel = kind === "ok" ? "可吊卸" : "排吊卸";

    $("#qTitle").textContent = `設備清單｜停駐點 ${stand}｜${kindLabel}｜${bandLabel}`;
    $("#qSub").textContent = `可吊卸(≤60/>60)=${agg.ok.le60}/${agg.ok.gt60}；排吊卸(≤60/>60)=${agg.plan.le60}/${agg.plan.gt60}`;

    const source = (STAND_TASKS[stand]?.[kind] || []);
    const filtered = source.filter(x=>{
      const t = Number(x.ton);
      return band==="le60" ? (Number.isFinite(t) && t<=60) : (Number.isFinite(t) && t>60);
    });

    // 排序：同一清單中，需求噸數高到低，方便派車人先看大件
    filtered.sort((p,q)=> (Number(q.ton)-Number(p.ton)) || p.eq.localeCompare(q.eq));

    $("#tbQuick").innerHTML = filtered.length ? filtered.map(x=>{
      return `
        <tr>
          <td><b>${escapeHtml(x.eq)}</b></td>
          <td>${escapeHtml(x.step || "—")}</td>
          <td class="right"><b>${Number(x.stepCount ?? 0)}</b></td>
          <td class="right"><b>${Number(x.ton)}T</b></td>
          <td>${escapeHtml(x.statusText || (kind==="ok"?"可吊卸":"排吊卸"))}</td>
        </tr>
      `;
    }).join("") : `<tr><td colspan="5" class="muted">此分類目前無設備（示意）</td></tr>`;

    $("#ovQuick").classList.add("show");
  }

  function closeQuick(){ $("#ovQuick").classList.remove("show"); }
  $("#btnQClose").addEventListener("click", closeQuick);
  $("#ovQuick").addEventListener("click", (e)=>{ if(e.target.id==="ovQuick") closeQuick(); });
  $("#btnGoAssign").addEventListener("click", ()=>{
    if(!quickStand) return;
    closeQuick();
    openAssignFromDashboard(quickStand);
  });

  /************************************************************
   * Assign Modal
   ************************************************************/
  let assignStand = null;

  function vendorName(vendorId){
    return VENDORS.find(v=>v.id===vendorId)?.name || vendorId;
  }

  function openAssignFromDashboard(stand){
    assignStand = stand;
    const agg = getStandAgg(stand);

    $("#aStand").value = stand;
    $("#aSub").textContent = `建立已派工：停駐點 ${stand}（可吊卸=${agg.totalOk}、排吊卸=${agg.totalPlan}）`;

    $("#aTon").innerHTML = TON_CHOICES.map(t=>`<option value="${t}">${t}噸</option>`).join("");
    $("#aTon").value = 160;

    $("#aVendor").innerHTML = VENDORS.map(v=>`<option value="${v.id}">${v.name}</option>`).join("");
    $("#aVendor").value = "OO";

    $("#aDate").value = tomorrowISO();
    $("#aNote").value = "";

    $("#aHintOk").textContent = `可吊卸：${agg.totalOk}`;
    $("#aHintPlan").textContent = `排吊卸：${agg.totalPlan}`;

    $("#ovAssign").classList.add("show");
  }

  function closeAssign(){ $("#ovAssign").classList.remove("show"); }
  $("#btnAClose").addEventListener("click", closeAssign);
  $("#btnACancel").addEventListener("click", closeAssign);
  $("#ovAssign").addEventListener("click", (e)=>{ if(e.target.id==="ovAssign") closeAssign(); });

  $("#btnACreate").addEventListener("click", ()=>{
    if(!assignStand) return;
    const ton = Number($("#aTon").value);
    const date = $("#aDate").value;
    const vendorId = $("#aVendor").value;
    const note = $("#aNote").value.trim();

    createAssignment(assignStand, date, ton, vendorId, note);
    closeAssign();
  });

  function createAssignment(stand, date, ton, vendorId, note){
    const agg = getStandAgg(stand);
    const id = `CA-${String(seq).padStart(4,"0")}`;
    seq++;

    assignments.unshift({
      id, stand, date, ton,
      vendorId,
      vendorName: vendorName(vendorId),
      note,
      snapshot: {
        okLe60: agg.ok.le60, okGt60: agg.ok.gt60,
        planLe60: agg.plan.le60, planGt60: agg.plan.gt60
      },
      createdAt: new Date().toISOString()
    });

    renderAssignments();
    renderDashboard();
    toast(`已建立已派工：${id}（${stand} / ${ton}噸）`);
  }

  /************************************************************
   * Assignments: print / delete
   ************************************************************/
  function renderAssignments(){
    $("#tbAssignments").innerHTML = assignments.length ? assignments.map(a=>{
      const hint = `可吊卸(≤60/>60) ${a.snapshot.okLe60}/${a.snapshot.okGt60} ｜ 排吊卸(≤60/>60) ${a.snapshot.planLe60}/${a.snapshot.planGt60}`;
      return `
        <tr>
          <td><b>${a.id}</b></td>
          <td>${escapeHtml(a.date)}</td>
          <td><b>${escapeHtml(a.stand)}</b></td>
          <td class="right"><b>${a.ton}噸</b></td>
          <td>${escapeHtml(a.vendorName)}</td>
          <td>${escapeHtml(hint)}</td>
          <td>${escapeHtml(a.note || "")}</td>
          <td class="right">
            <button class="warn" data-print="${a.id}">列印進場表</button>
            <button class="danger" data-del="${a.id}">刪除</button>
          </td>
        </tr>
      `;
    }).join("") : `<tr><td colspan="8" class="muted">尚無已派工資料（示意）。請從停駐區按【預定派車】建立。</td></tr>`;

    $$("button[data-print]").forEach(btn=>{
      btn.addEventListener("click", ()=> printById(btn.getAttribute("data-print")));
    });
    $$("button[data-del]").forEach(btn=>{
      btn.addEventListener("click", ()=> deleteById(btn.getAttribute("data-del")));
    });
  }

  function findAssignment(id){ return assignments.find(x=>x.id===id) || null; }

  function deleteById(id){
    const a = findAssignment(id);
    if(!a) return;
    assignments = assignments.filter(x=>x.id !== id);
    renderAssignments();
    renderDashboard();
    toast(`已刪除：${id}`);
  }

  /************************************************************
   * Print: 進場表（同樣不需要原因/時間，照你規則）
   ************************************************************/
 function buildPrintSheetHTML(a){
  const obj = STAND_TASKS[a.stand] || {ok:[], plan:[]};

  // 1) 可吊掛（可吊卸）：只做 60T 分級統計（不列設備）
  const okAgg = splitCounts(obj.ok); // {le60, gt60}
  const okTotal = (obj.ok || []).length;

  // 2) 排吊卸：列出設備 + 吊掛前未完成工序（必填）
  //    若沒提供 preLiftTodoSteps，就用「（未提供）」提醒現場補資料
  const planList = (obj.plan || []).map(x=>{
    const todo = Array.isArray(x.preLiftTodoSteps) ? x.preLiftTodoSteps : null;
    return {
      eq: x.eq,
      ton: Number(x.ton),
      step: x.step || "—",
      todoSteps: todo && todo.length ? todo : ["（未提供：請填寫吊掛前待完成工序）"],
      note: x.note || ""
    };
  });

  // 排序：需求噸數大到小（大件通常優先趕工）
  planList.sort((p,q)=> (q.ton - p.ton) || p.eq.localeCompare(q.eq));

  const meta = `
    <div class="printMeta">
      <div><b>吊車廠商：</b>${escapeHtml(a.vendorName)}</div>
      <div><b>噸數：</b>${a.ton}噸</div>
      <div><b>停駐點：</b>${escapeHtml(a.stand)}</div>
      <div><b>入場日期：</b>${escapeHtml(a.date)}</div>
    </div>
  `;

  const okSummary = `
    <h3 style="margin:12px 0 6px;">一、可吊掛概況（只統計）</h3>
    <table class="printTable">
      <thead>
        <tr>
          <th>分級</th>
          <th style="text-align:right;">數量</th>
        </tr>
      </thead>
      <tbody>
        <tr>
          <td>60T 以下（≤60T）</td>
          <td style="text-align:right;"><b>${okAgg.le60}</b></td>
        </tr>
        <tr>
          <td>60T 以上（>60T）</td>
          <td style="text-align:right;"><b>${okAgg.gt60}</b></td>
        </tr>
        <tr>
          <td><b>合計</b></td>
          <td style="text-align:right;"><b>${okTotal}</b></td>
        </tr>
      </tbody>
    </table>
  `;

  const planRows = planList.map((t,i)=>{
    const todoHtml = t.todoSteps.map(s=>`<li>${escapeHtml(s)}</li>`).join("");
    return `
      <tr>
        <td style="width:44px;">${i+1}</td>
        <td style="width:120px;"><b>${escapeHtml(t.eq)}</b></td>
        <td style="width:80px;text-align:right;">${Number.isFinite(t.ton)? t.ton+"噸":"—"}</td>
        <td style="width:160px;">${escapeHtml(t.step)}</td>
        <td>
          <ul style="margin:0; padding-left:18px;">
            ${todoHtml}
          </ul>
        </td>
        <td style="width:160px;">${escapeHtml(t.note)}</td>
      </tr>
    `;
  }).join("");

  const planSection = `
    <h3 style="margin:14px 0 6px;">二、排吊卸清單（趕工排工序 / 通知準備）</h3>
    <div style="font-size:12px;color:#333;line-height:1.6;">
      目的：1) 讓現場把「吊掛前待完成工序」優先排入趕工；2) 通知相關準備作業（清場、隔離、申請、拆除、清洗等）。
    </div>

    <table class="printTable">
      <thead>
        <tr>
          <th style="width:44px;">序</th>
          <th style="width:120px;">設備</th>
          <th style="width:90px;text-align:right;">需求噸數</th>
          <th style="width:160px;">目前工序</th>
          <th>吊掛前未完成工序（必填）</th>
          <th style="width:160px;">備註</th>
        </tr>
      </thead>
      <tbody>
        ${planRows || `<tr><td colspan="6">（目前無排吊卸設備）</td></tr>`}
      </tbody>
    </table>
  `;

  return `
    <div class="printPage">
      <h2>吊車派工單（現場趕工用）</h2>
      <div style="font-size:12px;color:#333;line-height:1.6;">
        本單據目的：<b>趕工排工序</b>、<b>通知準備作業</b>。可吊掛只統計；排吊卸需列出「吊掛前未完成工序」。
      </div>
      ${meta}
      ${okSummary}
      ${planSection}

      <div style="margin-top:14px;font-size:12px;color:#333;">
        施工主任簽收：＿＿＿＿＿＿＿　　現場確認時間：＿＿＿＿＿＿＿
      </div>
    </div>
  `;
}


  function printById(id){
    const a = findAssignment(id);
    if(!a){ toast("找不到該筆已派工資料"); return; }
    $("#printOnly").innerHTML = buildPrintSheetHTML(a);
    window.print();
  }

  /************************************************************
   * Demo refresh: 模擬工序推進（排吊卸 → 可吊卸）
   ************************************************************/
  $("#btnRefresh").addEventListener("click", ()=>{
    for(const k of Object.keys(STAND_TASKS)){
      const obj = STAND_TASKS[k];
      if(obj.plan.length && Math.random() < 0.55){
        const x = obj.plan.shift();
        if(x){
          x.statusText = "可吊卸";
          obj.ok.push(x);
        }
      }
      if(obj.ok.length && Math.random() < 0.12){
        const x = obj.ok.pop();
        if(x){
          x.statusText = "排吊卸";
          obj.plan.unshift(x);
        }
      }
    }
    renderDashboard();
    toast("已更新（示意：工序推進）");
  });

  /************************************************************
   * Init
   ************************************************************/
  function init(){
    $("#dayLabel").textContent = `日期：${tomorrowISO()}`;
    renderAssignments();
    renderDashboard();
  }
  init();
</script>
</body>
</html>
