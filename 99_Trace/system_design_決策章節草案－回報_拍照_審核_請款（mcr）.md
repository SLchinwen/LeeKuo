<!-- Generated by Prompt: system-design-decision-log.md -->
<!-- Stage: 20-design -->
<!-- Date: 2026-01-29 -->
---
title: "System Design 決策章節草案－回報×拍照×審核×請款（MCR）"
date: "2026-01-29"

# 治理與歸屬
organization: "client-project"
client: "立國工程股份有限公司"
project: "MaintCloud Report（MCR）"
module: "現場回報與請款核心流程"

# 文件屬性
category: "spec"
type: "Design"

# 生命週期
status: "Draft"
approval_status: "internal"
needs_review: true
confidence: 0.7

# 發布控制
visibility: "internal"
publish_target: "none"

# 來源追溯
origin: "ai-generated"
authoring_mode: "assistant"
prompt_id: "system-design-decision-log"
prompt_stage: "20-design"
generation_mode: "prompt-driven"
---

# System Design 決策章節草案－回報×拍照×審核×請款（MCR）

> 本文件為 System Design 的「決策章節（Decision Log / Design Constraints）」草案，
> 用於在進入資料表與 API 設計前，先鎖定高風險決策與約束，避免實作期間反覆。

---

## D-01 PhotoPending 是否允許進入請款/核定

### 現況
* 工序可先回報完成，若 need_photo=是但未上傳照片，則 photo_status=Pending。

### 問題
* 若 photo_status=Pending 仍可核定/請款，會造成「資料不足但流程往後推」的可稽核風險。

### 決策選項
1. **嚴格模式（建議）**：PhotoPending 不可進入 Approved / 請款試算
2. 寬鬆模式：允許進入，但報表需標紅並保留補件窗口

### 決策（已確認）
✅ 採用 **寬鬆模式**：
* need_photo=是 且 photo_status=Pending →
  - 仍可核定與請款
  - 報表需標示 PhotoPending 狀態

### 影響範圍
* PRD：審核畫面需提示「缺照片不可核定」
* System Design：狀態機與查詢 API 需支援此 gate

---

## D-02 關帳後是否允許換圖/補拍

### 現況
* 關帳會鎖定請款資料，照片允許換圖且保留歷史。

### 問題
* 若關帳後仍可自由換圖，會出現「送出請款後證據變動」的合規與信任問題。

### 決策選項
1. **關帳後禁止直接換圖（建議）**：需走更正流程
2. 關帳後允許換圖：但必填原因且產生更正紀錄（仍有爭議）

### 決策（已確認）
✅ 採用「請款關帳後不允許更正」：
* 關帳前：允許補拍/換圖（保留歷史）
* 關帳後：
  - 不允許任何更正/換圖

### 影響範圍
* 資料表：關帳後寫入鎖定狀態
* API：關帳後禁止任何變更入口

---

## D-03 文件產出為快照（Snapshot），不得視為即時同步

### 現況
* Excel/Word 允許依 need_report/need_photo/狀態篩選產出。

### 問題
* 若文件被誤解為「永遠同步最新資料」，會導致版本混亂。

### 決策
✅ 文件產出一律視為 **快照**：
* 每次產出都需寫入 metadata：
  - 產出時間
  - 產出人
  - 篩選條件
  - 資料基準（關帳/未關帳）

---

## D-04 退回（Returned）的影響範圍與最小狀態策略

### 現況
* 審核端可退回，現場可補件，原回報資料保留。

### 問題
* 若退回被拆成「退回照片/退回回報」會造成狀態爆炸。

### 決策
✅ 退回一律作用於「工序層」：
* Returned 狀態表示此工序需補件
* 退回原因需明確指出：缺照片 / 圖片不清楚 / 說明不足

---

## D-05 吊車相關欄位的可編輯性

### 現況
* crane_tonnage / parking_zone_group 用於吊車決策彙總。

### 問題
* 若現場可隨意改，會破壞吊車看板可信度。

### 決策
✅ 吊車欄位預設 **只讀**：
* 來源：型式工序模板 / 設備主檔
* 若需修正：回到主檔維護，不在回報當下改

---

## 決策狀態表（用於需求確認會）

| Decision ID | 決策主題 | 建議預設 | 決策狀態 |
|---|---|---|---|
| D-01 | PhotoPending gate | 寬鬆模式 | ✅ Confirmed |
| D-02 | 關帳後換圖 | 請款關帳後不可更正 | ✅ Confirmed |
| D-03 | 文件快照 | 快照＋metadata | ✅ Default |
| D-04 | 退回影響範圍 | 退回作用於工序層 | ✅ Default |
| D-05 | 吊車欄位可編輯性 | 只讀 | ✅ Default |

## D-06 設備完工回報（可請款通知）

### 現況
* 回報與拍照完成後，尚缺「設備完工」的獨立通知節點。

### 決策（已確認）
✅ 增加「設備完工回報」節點：
* 由專案經理提交
* 可重開修改
* 作為請款整理/文件產出的前置條件

> 建議先鎖 D-01 / D-02，避免後續 System Design 與實作反覆。

